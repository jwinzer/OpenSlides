<os-head-bar [goBack]="true" [nav]="false">
    <div class="title-slot">
        <h2 *ngIf="!!poll">{{ poll.title }}</h2>
    </div>

    <div
        class="menu-slot"
        *osPerms="[permission.assignmentsCanManage, permission.coreCanManageProjector];
        or: hasSingleVotes && votesDataObservable"
    >
        <button type="button" mat-icon-button [matMenuTriggerFor]="pollDetailMenu">
            <mat-icon>more_vert</mat-icon>
        </button>
    </div>
</os-head-bar>

<mat-card class="os-card spacer-bottom-60">
    <ng-container [ngTemplateOutlet]="viewTemplate"></ng-container>
</mat-card>

<!-- Detailview for poll -->
<ng-template #viewTemplate>
    <div *ngIf="isReady">
        <h1>{{ poll.title }}</h1>
        <div>
            <!-- Voting type -->
            <span *ngIf="poll.type !== 'analog'"> {{ poll.typeVerbose | translate }} &middot; </span>

            <!-- State -->
            <span>{{ poll.stateVerbose | translate }}</span>

            <!-- Voting principle -->
            <span *ngIf="isVoteWeightActive"> &middot; {{ pollService.getVotingPrincipleName(poll.voting_principle) }}
            </span>
        </div>

        <div class="assignment-result-wrapper" *ngIf="poll && poll.stateHasVotes">
            <!-- Result Table -->
            <os-assignment-poll-detail-content [poll]="poll"></os-assignment-poll-detail-content>

            <!-- Result Chart -->
            <div class="chart-wrapper">
                <os-charts
                    class="assignment-result-chart"
                    *ngIf="chartDataSubject.value"
                    [labels]="candidatesLabels"
                    [data]="chartDataSubject | async"
                ></os-charts>
            </div>

            <!-- Single Votes Table -->
            <div class="named-result-table" *ngIf="poll.type === 'named'">
                <h3>{{ 'Single votes' | translate }}</h3>
                <os-list-view-table
                    class="single-votes-table"
                    *ngIf="votesDataObservable"
                    [listObservable]="votesDataObservable"
                    [columns]="columnDefinitionSingleVotes"
                    [filterProps]="filterProps"
                    [allowProjector]="false"
                    [fullScreen]="false"
                    [vScrollFixed]="-1"
                    listStorageKey="assignment-poll-vote"
                    [showListOfSpeakers]="false"
                    [showMenu]="false"
                >
                    <!-- Header -->
                    <div *pblNgridHeaderCellDef="'user'; col as col">
                        {{ col.label | translate }}
                    </div>
                    <div *pblNgridHeaderCellDef="'votes'; col as col">
                        {{ col.label | translate }}
                    </div>

                    <!-- Content -->
                    <div *pblNgridCellDef="'user'; row as vote">
                        <div *ngIf="vote.user">
                            {{ vote.user.getShortName() }}
                            <div class="user-subtitle">
                                <!-- Level and number -->
                                <div *ngIf="vote.user.getLevelAndNumber()">
                                    {{ vote.user.getLevelAndNumber() }}
                                </div>

                                <!-- Vote weight -->
                                <div *osPerms="permission.usersCanSeeExtraData; and: isVoteWeightActive">
                                    {{ 'Vote weight' | translate }}: {{ vote.user.getVoteWeight(poll.voting_principle) }}
                                </div>

                                <!-- Delegation -->
                                <div *ngIf="vote.user.isVoteRightDelegated">
                                    <span>
                                        ({{ 'represented by' | translate }}
                                        {{ vote.user.voteDelegatedTo.getShortName() }})
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div *ngIf="!vote.user">
                            {{ 'Anonymous' | translate }}
                        </div>
                    </div>

                    <div *pblNgridCellDef="'votes'; row as vote">
                        <div class="single-vote-result" *ngFor="let candidate of vote.votes">{{ candidate }}</div>
                    </div>
                </os-list-view-table>
                <div *ngIf="!votesDataObservable">
                    {{ 'The individual votes were anonymized.' | translate }}
                </div>
            </div>
        </div>
    </div>

    <!-- Meta Infos -->
    <os-assignment-poll-meta-info [poll]="poll" [showCandidates]="showCandidatesInMetaInfo"></os-assignment-poll-meta-info>
</ng-template>

<!-- More Menu -->
<mat-menu #pollDetailMenu="matMenu">
    <button mat-menu-item (click)="downLoadPdf()" *ngIf="hasSingleVotes && votesDataObservable">
        <mat-icon>picture_as_pdf</mat-icon>
        <span>{{ 'PDF' | translate }}</span>
    </button>
    <os-projector-button [menuItem]="true" [object]="poll" *osPerms="permission.coreCanManageProjector">
    </os-projector-button>
    <button *osPerms="permission.assignmentsCanManage" mat-menu-item (click)="openDialog(poll)">
        <mat-icon>edit</mat-icon>
        <span>{{ 'Edit' | translate }}</span>
    </button>
    <button
        mat-menu-item
        *osPerms="permission.assignmentsCanManage; and: poll?.type === 'named' and votesDataObservable"
        (click)="pseudoanonymizePoll()"
    >
        <mat-icon>warning</mat-icon>
        <span>{{ 'Anonymize votes' | translate }}</span>
    </button>
    <mat-divider></mat-divider>
    <button *osPerms="permission.assignmentsCanManage" mat-menu-item (click)="deletePoll()">
        <mat-icon color="warn">delete</mat-icon>
        <span>{{ 'Delete' | translate }}</span>
    </button>
</mat-menu>
